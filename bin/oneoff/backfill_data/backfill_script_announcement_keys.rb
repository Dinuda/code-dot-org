#!/usr/bin/env ruby

# In order to unqiuely identify the announcements associated
# with a Script, we are generating a UUID key. This can then
# be used to accurately look up the translation amongst a
# Script's array of announcements.

require_relative '../../../dashboard/config/environment'
require 'pry'

def backfill_script_announcement_keys
  Script.all.each do |script|
    next unless script.announcements

    # Create UUID key for each announcement
    script.announcements.each do |announcement|
      announcement[:key] = SecureRandom.uuid unless announcement[:key]
    end
    script.save!

    # Update the scripts.en.yml translation file with new announcement keys
    units_yml = File.expand_path("#{Rails.root}/config/locales/scripts.en.yml")
    existing_i18n = File.exist?(units_yml) ? YAML.load_file(units_yml) : {}
    updated_i18n = Script.update_i18n(existing_i18n, {}, script.name, {announcements: script.announcements}.deep_symbolize_keys!)
    File.write(units_yml, "# Autogenerated scripts locale file.\n" + updated_i18n.to_yaml(line_width: -1))

    # Update its script_json
    script.write_script_json
  end
end

backfill_script_announcement_keys
